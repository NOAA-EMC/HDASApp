_filenames: &fv3file_names
  filename_core: '20200825.120000.fv_core.res.tile1.nc'
  filename_trcr: '20200825.120000.fv_tracer.res.tile1.nc'
  filename_sfcd: '20200825.120000.sfc_data.nc'
  filename_sfcw: '20200825.120000.fv_srf_wnd.res.tile1.nc'
  filename_cplr: '20200825.120000.coupler.res'

_filenames03: &fv3file_names03
  filename_core: '20200825.090000.fv_core.res.tile1.nc'
  filename_trcr: '20200825.090000.fv_tracer.res.tile1.nc'
  filename_sfcd: '20200825.090000.sfc_data.nc'
  filename_sfcw: '20200825.090000.fv_srf_wnd.res.tile1.nc'
  filename_cplr: '20200825.090000.coupler.res'

_filenames09: &fv3file_names09
  filename_core: '20200825.150000.fv_core.res.tile1.nc'
  filename_trcr: '20200825.150000.fv_tracer.res.tile1.nc'
  filename_sfcd: '20200825.150000.sfc_data.nc'
  filename_sfcw: '20200825.150000.fv_srf_wnd.res.tile1.nc'
  filename_cplr: '20200825.150000.coupler.res'

_geometry: &geometry_configs
  namelist filename: DataFix/input_hafs.nml
  field metadata override: Data/fieldmetadata/gfs-restart.yaml
  akbk: DataFix/fix/akbk65.nc
  npx: 721
  npy: 541
  npz: 65
  layout: [10,6]
  io_layout: [1,1]
  ntiles: 1
  fms initialization:
    namelist filename: DataFix/fmsmpp.nml
    field table filename: DataFix/field_table
  fieldsets:
    fieldset: DataFix/dynamics_lam_cmaq.yaml

cost function:
  cost type: 4D-Ens-Var
  time window:
      begin: &InitialDate '2020-08-25T09:00:00Z'
      length: PT6H
  subwindow: PT3H
  parallel subwindows: false
  geometry:
    <<: *geometry_configs
  analysis variables: &ana_vars [eastward_wind,northward_wind,air_temperature,air_pressure_thickness,water_vapor_mixing_ratio_wrt_moist_air,cloud_liquid_ice,cloud_liquid_water,ozone_mass_mixing_ratio]
  background:
    states:
    - datetime: *InitialDate
      filetype: fms restart
      datapath: Data/bkg
      <<: *fv3file_names03
      state variables: &state_vars [eastward_wind,northward_wind,air_temperature,air_pressure_thickness,water_vapor_mixing_ratio_wrt_moist_air,cloud_liquid_ice,cloud_liquid_water,ozone_mass_mixing_ratio,phis,slmsk,sheleg,vtype,stype,vfrac,stc,smc,snwdph,u_srf,v_srf,f10m] 
    - datetime: &AnaDate '2020-08-25T12:00:00Z'
      filetype: fms restart
      datapath: Data/bkg
      <<: *fv3file_names
      state variables: *state_vars
    - datetime: '2020-08-25T15:00:00Z'
      filetype: fms restart
      datapath: Data/bkg
      <<: *fv3file_names09
      state variables: *state_vars
  background error:
    covariance model: ensemble
    members from template:
      template:
        states:
        - datetime: *InitialDate
          filetype: fms restart
          state variables: *state_vars  
          datapath: ens/mem%mem%/
          <<: *fv3file_names03
        - datetime: *AnaDate
          filetype: fms restart
          state variables: *state_vars
          datapath: ens/mem%mem%/
          <<: *fv3file_names
        - datetime: '2020-08-25T15:00:00Z'
          filetype: fms restart
          state variables: *state_vars
          datapath: ens/mem%mem%/
          <<: *fv3file_names09
      pattern: '%mem%'
      nmembers: 5 
      zero padding: 3
    localization:
      localization method: SABER
      saber central block:
        saber block name: BUMP_NICAS
        active variables: *ana_vars
        read:
          io:
            data directory: Data/bump
            files prefix: fv3jedi_bumpparameters_nicas_lam_atm
            alias:
            - in code: common
              in file: t_250km
          drivers:
             multivariate strategy: duplicated
             read local nicas: true

#------------------------------------------------------------------------------
  observations:
     observers:
     - obs space:
         name: sfcshp
         obsdatain:
           engine:
             type: H5File
             obsfile: Data/obs/sfcshp.tm00.singleob.nc
         obsdataout:
           engine:
             type: H5File
             obsfile: diag_SFCSHP.prepbufr_singleobs.nc
             allow overwrite: true
         io pool:
           max pool size: 1
         observed variables: [airTemperature]
         simulated variables: [airTemperature]

       obs operator:
         name: Composite
         components:
         - name: VertInterp
           vertical coordinate: air_pressure
           observation vertical coordinate: pressure
           observation vertical coordinate group: MetaData
           interpolation method: log-linear
           variables:
           - name: airTemperature

       obs post filters:
         - filter: Perform Action
           filter variables:
           - name: airTemperature
           where:
           - variable: ObsType/airTemperature
             is_in: 180
           action:
             name: assign error
             error parameter: 0.92823
           defer to post: true
      # Adjusted error after initial assignment (qcmod.f90)
         - filter: Perform Action
           filter variables:
           - name: airTemperature
           where:
           - variable: ObsType/airTemperature
             is_in: 180
           action:
             name: inflate error
             inflation variable:
               name: ObsFunction/ObsErrorFactorConventional
               options:
                 test QCflag: PreQC
                 test QCthreshold: 3
                 inflate variables: [airTemperature]
                 pressure: MetaData/pressure
                 distance threshold: -1.
           defer to post: true
      # error inflation based on pressure check
         - filter: Perform Action
           filter variables:
           - name: airTemperature
           where:
           - variable: ObsType/airTemperature
             is_in: 180
           action:
             name: inflate error
             inflation variable:
               name: ObsFunction/ObsErrorFactorPressureCheck
               options:
                 variable: airTemperature
                 inflation factor: 8.0
                 geovar_sfc_geomz: surface_geometric_height
           defer to post: true
        #- filter: Bounds Check
      #  filter variables:
      #  - name: airTemperature
      #  minvalue: 195.0
      #  maxvalue: 327.0
      #  action:
      #    name: reject
      #- filter: Background Check
      #  filter variables:
      #  - name: airTemperature
      #  threshold: 7.0
      #  absolute threshold: 9.0
      #  action:
      #    name: reject
      #  defer to post: true

variational:
  minimizer:
    algorithm: DRPCG    # Derber-Rosati Conjugate Gradients
  iterations:
  - ninner: 50
    gradient norm reduction: 1e-60
    geometry:
      <<: *geometry_configs
    diagnostics:
      departures: bkgmob
final:
  diagnostics:
    departures: oman

output:
  filetype: fms restart
  datapath: Data/analysis/
  exp: 4denvar
  type: an
  first: PT0S
  date: *InitialDate
  frequency: PT3H
